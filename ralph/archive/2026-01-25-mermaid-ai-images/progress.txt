# Ralph Progress Log
Started: Sat Jan 24 22:43:44 CET 2026
---

## Codebase Patterns
- Frontend is Svelte 5 + TypeScript + Vite, located in `/frontend`
- Utility modules go in `frontend/src/lib/utils/`
- Tests use Vitest with `vi.mock()` for mocking, file pattern: `*.test.ts`
- Path alias `$lib` maps to `src/lib`
- Build output goes to `/embedded/dist` for Go embedding
- Typecheck command: `npm run check` (runs svelte-check + tsc)
- Go backend packages go in `internal/` directory
- Go tests use `*_test.go` pattern, run with `go test ./...`
- Use `httptest.NewServer` for mocking HTTP APIs in Go tests
- Environment variables for secrets (e.g., `GEMINI_API_KEY`) loaded via godotenv
- Use functional options pattern for configurable clients (e.g., `NewClient(apiKey, WithTimeout())`)
- TUI is Bubble Tea based, located in `internal/tui/`

---

## 2026-01-24 22:47 - US-001
- What was implemented: Added mermaid.js to frontend bundle with manual initialization
- Files changed:
  - `frontend/package.json` - Added mermaid dependency
  - `frontend/package-lock.json` - Lock file updated
  - `frontend/src/main.ts` - Import and initialize mermaid
  - `frontend/src/lib/utils/mermaid.ts` - New mermaid utility module
  - `frontend/src/lib/utils/mermaid.test.ts` - Unit tests (7 tests)
- **Learnings for future iterations:**
  - Mermaid is configured with `startOnLoad: false` for manual control over rendering
  - The mermaid utility exports `initializeMermaid()`, `isMermaidInitialized()`, `resetMermaidInitialization()`, and `getMermaid()`
  - Some pre-existing test failures in SlideRenderer.test.ts and SlideContainer.test.ts (24 failures) - unrelated to mermaid changes
  - Build includes mermaid diagram chunks (stateDiagram, flowDiagram, ganttDiagram, etc.)
---

## 2026-01-24 22:56 - US-002
- What was implemented: Mermaid code block detection and rendering in SlideRenderer
- Files changed:
  - `frontend/src/lib/components/SlideRenderer.svelte` - Added mermaid rendering with $effect hook and CSS styles
  - `frontend/src/lib/utils/mermaid.ts` - Added `renderMermaidDiagram()` and `renderMermaidBlocksInElement()` functions
  - `frontend/src/lib/utils/mermaid.test.ts` - Added 12 new unit tests (now 19 total)
- **Learnings for future iterations:**
  - Mermaid rendering must happen client-side after DOM is mounted (use `$effect` + `queueMicrotask`)
  - Query selector for mermaid blocks: `pre > code.language-mermaid`
  - SVG output from `mermaid.render()` returns `{ svg: string }`
  - Error handling shows both error message and original code in styled container
  - Static build (`tap build`) uses minimal HTML/JS without Svelte, so mermaid won't render there
  - To test Svelte frontend locally, can embed presentation data in `index.html` with `#presentation-data` script tag
---

## 2026-01-24 23:15 - US-003
- What was implemented: Theme-aware error styling for mermaid syntax errors
- Files changed:
  - `frontend/src/lib/themes/theme-tokens.css` - Added `--color-error` and `--color-error-bg` default variables
  - `frontend/src/lib/themes/paper.css` - Added error colors (warm red #dc2626)
  - `frontend/src/lib/themes/noir.css` - Added error colors (amber #f59e0b to complement gold)
  - `frontend/src/lib/themes/aurora.css` - Added error colors (pink #f472b6 to match aurora palette)
  - `frontend/src/lib/themes/phosphor.css` - Added error colors (red phosphor #ff3333)
  - `frontend/src/lib/themes/poster.css` - Added error colors (red #ef4444 matching accent)
  - `frontend/src/lib/components/SlideRenderer.svelte` - Updated mermaid error CSS to use theme tokens
- **Learnings for future iterations:**
  - Themes use CSS custom properties defined in `.theme-{name}` classes
  - Error handling was already implemented in US-002, this story added theme-aware styling
  - Use `var(--property, fallback)` syntax for graceful degradation
  - The `color-mix()` CSS function can be used for semi-transparent theme colors
  - Tests for error handling exist in `mermaid.test.ts` (19 tests total)
---

## 2026-01-24 23:10 - US-004
- What was implemented: Auto-scaling for mermaid diagrams to fit within slide bounds
- Files changed:
  - `frontend/src/lib/components/SlideRenderer.svelte` - Added CSS constraints for mermaid diagram scaling
- **Learnings for future iterations:**
  - The `.mermaid-diagram` container already exists (created in US-002), just needed CSS constraints
  - `max-height: 70vh` limits vertical overflow while leaving room for slide title and text
  - `overflow: hidden` on container prevents any bleed
  - SVG needs both `max-width: 100%` and `max-height: 100%` to scale proportionally
  - `object-fit: contain` ensures aspect ratio is preserved
  - Setting `width: auto` and `height: auto` on SVG prevents forced upscaling
  - Tested by embedding presentation data in `index.html` with `#presentation-data` script tag (see US-002 notes)
---

## 2026-01-24 23:20 - US-005
- What was implemented: Mermaid theme mapping for Paper and Noir themes
- Files changed:
  - `frontend/src/lib/utils/mermaid.ts` - Added `getMermaidTheme()` function and `MermaidThemeConfig` interface, updated `initializeMermaid()` to accept theme parameter
  - `frontend/src/lib/utils/mermaid.test.ts` - Added 20 new unit tests for theme mapping (now 39 total)
  - `frontend/src/lib/components/SlideRenderer.svelte` - Added `theme` prop and pass it to mermaid rendering
  - `frontend/src/App.svelte` - Pass theme prop to SlideRenderer
  - `frontend/src/Presenter.svelte` - Pass theme prop to SlideRenderer
  - `examples/theme-paper.md` - Added mermaid diagram example slide
  - `examples/theme-noir.md` - Added mermaid diagram example slide
- **Learnings for future iterations:**
  - Mermaid has built-in themes: 'default', 'dark', 'forest', 'neutral', 'base'
  - Use `themeVariables` to customize colors, fonts, and other diagram properties
  - Paper theme maps to 'neutral' mermaid theme with stone accent (#78716c)
  - Noir theme maps to 'dark' mermaid theme with gold accent (#d4af37)
  - `initializeMermaid()` reinitializes mermaid when theme changes (tracks `currentTheme`)
  - Theme prop flows: App/Presenter -> SlideRenderer -> renderMermaidBlocksInElement
  - Cast theme variables to `Theme` type when derived from `string | null` sources
---

## 2026-01-24 23:25 - US-006
- What was implemented: Mermaid theme mapping for Aurora, Phosphor, and Poster themes
- Files changed:
  - `frontend/src/lib/utils/mermaid.ts` - Added theme configs for aurora, phosphor, poster
  - `frontend/src/lib/utils/mermaid.test.ts` - Added 12 new unit tests for new themes (now 51 total)
  - `examples/theme-aurora.md` - Added mermaid diagram example slide
  - `examples/theme-phosphor.md` - Added mermaid diagram example slide
  - `examples/theme-poster.md` - Added mermaid diagram example slide
- **Learnings for future iterations:**
  - Aurora: Uses 'forest' mermaid theme with teal (#14b8a6) accent, electric blue (#0ea5e9) lines, purple (#4c1d95) secondary, Space Grotesk font
  - Phosphor: Uses 'dark' mermaid theme with phosphor green (#00ff00) throughout, JetBrains Mono font
  - Poster: Uses 'default' mermaid theme with high contrast (white nodes #fafafa on dark bg #0d0d0f), coral accent (#ff6b4a), Inter font
  - Reference theme CSS files in `/frontend/src/lib/themes/` to extract accurate color values
  - Browser verification requires TTY (dev server uses BubbleTea TUI), manual verification needed in non-TTY environments
---

## 2026-01-25 01:35 - US-007
- What was implemented: Mermaid diagrams re-render automatically when theme changes
- Files changed:
  - `frontend/src/lib/utils/mermaid.ts` - Store code/theme in data attributes, re-render on theme change
  - `frontend/src/lib/utils/mermaid.test.ts` - Added 7 new unit tests for theme re-rendering (now 58 total)
- **Learnings for future iterations:**
  - Mermaid diagrams replace `<pre><code>` with `<div class="mermaid-diagram">` after render
  - To re-render on theme change, store original code in `data-mermaid-code` attribute
  - Track current theme in `data-mermaid-theme` to detect when re-rendering is needed
  - Error containers can also retry rendering when theme changes (might succeed with new theme)
  - The `$effect` in SlideRenderer.svelte already tracks `theme` prop - just need to handle re-rendering in mermaid utility
---

## 2026-01-25 02:00 - US-008
- What was implemented: Gemini API client for image generation in Go backend
- Files changed:
  - `internal/gemini/client.go` - New Gemini API client with GenerateImage function
  - `internal/gemini/client_test.go` - 27 unit tests with mocked HTTP responses
- **Learnings for future iterations:**
  - Go backend packages go in `internal/` directory
  - Use `httptest.NewServer` for mocking HTTP APIs in tests
  - Use functional options pattern (`WithBaseURL()`, `WithModel()`, etc.) for client configuration
  - API key is read from `GEMINI_API_KEY` environment variable
  - Nano Banana Pro model ID is `gemini-3-pro-image-preview`
  - API endpoint: `https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent`
  - Authentication via `x-goog-api-key` header
  - Request needs `"responseModalities": ["TEXT", "IMAGE"]` in generationConfig
  - Response returns base64-encoded image in `candidates[].content.parts[].inlineData`
  - Structured error types: auth, rate_limit, content_policy, invalid_request, server, network, no_image
  - Always mask API key in error messages with `strings.ReplaceAll()`
  - `HasAPIKey()` helper exported for TUI to check if API key is configured
---

## 2026-01-25 - US-009
- What was implemented: Image generation shortcut 'i' in dev TUI with API key validation
- Files changed:
  - `internal/tui/dev.go` - Added 'i' key handler, showImageGenerator flag, ShowImageGenerator() and ResetImageGenerator() methods, updated help text
  - `internal/tui/dev_test.go` - Added 6 unit tests for key handling and API key validation
- **Learnings for future iterations:**
  - DevModel uses `showThemePicker` and `showImageGenerator` boolean flags for overlay state
  - Use `gemini.HasAPIKey()` to check if API key is configured before starting image generation
  - Errors should be both set via `SetError()` and logged as events via `addEvent()` for visibility
  - Help text in `viewHelp()` uses `fmt.Sprintf` with `keyStyle.Render()` for key highlighting
  - Key handlers return early with `if m.showImageGenerator { return m, nil }` to prevent re-entry
---

## 2026-01-25 - US-010
- What was implemented: Slide selector for image generation with slide navigation
- Files changed:
  - `internal/tui/imagegen.go` - New ImageGenModel with slide selection step
  - `internal/tui/imagegen_test.go` - 15 unit tests for slide parsing, navigation, and view rendering
  - `internal/tui/dev.go` - Integrated ImageGenModel, added handleImageGeneratorKey() method
  - `internal/tui/dev_test.go` - Updated test for image generation with API key to use temp markdown file
- **Learnings for future iterations:**
  - ImageGenModel handles its own tea.Model interface, returns nil on cancel to signal parent
  - Slide parsing extracts titles from markdown headings or falls back to first non-empty line
  - Use `frontmatterRe` to remove YAML frontmatter before parsing slides
  - DevModel delegates to ImageGenModel for key handling when image generator is active
  - Returning nil from Update signals cancellation (non-standard pattern but effective)
  - Test files need temp markdown files when ImageGenModel is created during 'i' key handling
---

## 2026-01-25 - US-011
- What was implemented: Detection of existing AI-generated images on slides
- Files changed:
  - `internal/tui/imagegen.go` - Added AIImageInfo struct, parseAIImages(), aiImageRe regex, updated SlideInfo with AIImages slice, updated viewSlideSelect() to show indicators
  - `internal/tui/imagegen_test.go` - Added 4 new test functions for AI image parsing and view rendering with indicators
- **Learnings for future iterations:**
  - AI-generated images are tracked via HTML comments: `<!-- ai-prompt: ... -->` followed by `![](path)` on next line
  - The regex `aiImageRe` requires the image to be directly on the next line (no blank lines) to be associated
  - Use `[ \t]*` to allow leading spaces but not newlines
  - SlideInfo already had HasAIImages and AIImageCount fields (added in US-010), just needed AIImages slice and parsing
  - View shows `[has 1 AI image]` or `[has N AI images]` as muted, italic text next to slide title
---

## 2026-01-25 - US-012
- What was implemented: Add/regenerate options for slides with existing AI images
- Files changed:
  - `internal/tui/imagegen.go` - Added ImageGenStepImageSelect step, ImageSelectOption struct, new fields (ImageOptions, ImageOptionIndex, SelectedImage, Prompt), buildImageOptions(), viewImageSelect(), handleImageSelectKey()
  - `internal/tui/imagegen_test.go` - Added 11 new test functions for image selection workflow (now 30+ tests)
- **Learnings for future iterations:**
  - ImageGenModel workflow: SlideSelect -> ImageSelect (if has AI images) -> Prompt -> Generating -> Done
  - Slides without AI images skip ImageSelect step and go directly to Prompt
  - ImageSelectOption.IsAddNew=true for "Add new image", false for regenerate options
  - Long prompts are truncated to 40 chars for display, but full prompt is preserved in AIImage
  - SelectedImage is set when regenerating, nil when adding new
  - Prompt is pre-filled with existing prompt when regenerating
  - Pressing esc in ImageSelect goes back to SlideSelect (clears ImageOptions and ImageOptionIndex)
---

## 2026-01-25 - US-013
- What was implemented: Prompt input step for image generation using textarea component
- Files changed:
  - `internal/tui/imagegen.go` - Added promptInput textarea.Model field, handlePromptKey(), viewPrompt(), submitPrompt(); Updated handleSlideSelectKey() and handleImageSelectKey() to initialize and focus textarea
  - `internal/tui/imagegen_test.go` - Added 11 new test functions for prompt input handling (now 41+ tests)
- **Learnings for future iterations:**
  - Use `bubbles/textarea` (not textinput) for multi-line input support
  - Textarea needs Focus() called to receive input, and Blink cmd returned for cursor animation
  - Non-key messages (like blink messages) must be passed to textarea in Update()
  - Enter key submits the prompt (single-line behavior); use ctrl+d as alternative
  - Empty/whitespace-only prompts show error and stay in prompt step
  - Esc goes back to ImageSelect if slide has AI images, otherwise to SlideSelect
  - Textarea value is set before transitioning to prompt step (SetValue for pre-fill or empty)
---

## 2026-01-25 - US-014
- What was implemented: Image generation with progress spinner and error handling
- Files changed:
  - `internal/tui/imagegen.go` - Added spinner, ImageGenerateResult struct, imageGenerateMsg, generateImageCmd(), handleGeneratingKey(), handleImageGenerateResult(), viewGenerating(), formatAPIError(); Updated Update() for spinner tick and result messages; Added IsGenerating and GeneratedImage fields
  - `internal/tui/imagegen_test.go` - Added 16 new test functions for generating step, spinner, success/error handling, retry, and API error formatting
  - `internal/tui/dev.go` - Forward non-key messages to ImageGenModel when active for spinner animation; Block 'i' shortcut while IsGenerating is true
- **Learnings for future iterations:**
  - Use `bubbles/spinner` for animated progress indicators
  - Spinner needs Tick cmd started when entering generating step: `tea.Batch(m.spinner.Tick, generateCmd)`
  - Non-key messages (spinner.TickMsg, imageGenerateMsg) must be forwarded from parent DevModel to child ImageGenModel
  - Generation command captures prompt value before returning closure (to avoid stale references)
  - Error handling: stay in generating step but show error with retry/cancel options
  - Only allow retry ('r') and cancel ('esc') when there's an error, ignore keys while actively generating
  - API errors are converted to user-friendly messages via formatAPIError() checking gemini.ErrorType
  - On success, GeneratedImage is set and step advances to ImageGenStepDone
---

## 2026-01-25 - US-015
- What was implemented: Images directory creation logic for AI-generated images
- Files changed:
  - `internal/tui/imagegen.go` - Added GetImagesDir() and EnsureImagesDir() functions, added path/filepath import
  - `internal/tui/imagegen_test.go` - Added 8 unit tests for directory creation logic
- **Learnings for future iterations:**
  - GetImagesDir() returns "images/" relative to the markdown file's directory using filepath.Dir() and filepath.Join()
  - EnsureImagesDir() is idempotent - safe to call multiple times
  - os.MkdirAll creates all parent directories if needed (recursive)
  - os.Stat checks if path exists; os.IsNotExist(err) detects missing paths
  - Return error if "images" path exists but is a file (not directory)
  - Default permissions 0755 for directories
---

## 2026-01-25 - US-016
- What was implemented: Save generated image to disk with content-hashed filename
- Files changed:
  - `internal/tui/imagegen.go` - Added GenerateImageFilename(), GetExtensionFromContentType(), and SaveGeneratedImage() functions; added crypto/sha256 and encoding/hex imports
  - `internal/tui/imagegen_test.go` - Added 16 unit tests for filename generation and file saving
- **Learnings for future iterations:**
  - Use crypto/sha256 and encoding/hex for content hashing
  - SHA256 hash returns [32]byte, use hex.EncodeToString(hash[:]) to convert to hex string
  - Take first 8 chars of hex hash for filename (16 hex chars = 8 bytes of randomness)
  - SaveGeneratedImage() returns relative path "images/generated-{hash}.{ext}" suitable for markdown
  - GetExtensionFromContentType() maps MIME types to file extensions, defaults to "png"
  - Use 0644 permissions for image files (readable by all, writable by owner)
---

## 2026-01-25 - US-017
- What was implemented: Insert AI-generated image into markdown file
- Files changed:
  - `internal/tui/imagegen.go` - Added InsertImageIntoMarkdown() and insertImageIntoSlide() functions
  - `internal/tui/imagegen_test.go` - Added 11 unit tests for markdown insertion logic and integration tests for file modification
- **Learnings for future iterations:**
  - InsertImageIntoMarkdown() uses the model's SelectedIndex and Prompt fields to insert the image
  - insertImageIntoSlide() handles frontmatter separately from content, rebuilds with "---\n" separators
  - Empty slides are skipped when counting slide indices (matching parseSlides behavior)
  - Image markdown format: `<!-- ai-prompt: {prompt} -->\n![](imagePath)`
  - Existing images/content on slides are preserved
  - Hot reload is triggered automatically when the markdown file is written (file watcher picks up changes)
---

## 2026-01-25 - US-018
- What was implemented: Image regeneration handling - delete old images and update markdown in-place
- Files changed:
  - `internal/tui/imagegen.go` - Added DeleteOldImage() and ReplaceImageInMarkdown() functions, plus replaceImageInContent() helper
  - `internal/tui/imagegen_test.go` - Added 10 new tests for image regeneration workflow
- **Learnings for future iterations:**
  - DeleteOldImage() resolves the image path relative to markdown file directory using filepath.Dir() and filepath.Join()
  - ReplaceImageInMarkdown() preserves image position in the slide (doesn't move to end)
  - replaceImageInContent() uses regexp.QuoteMeta() to escape special characters in prompt/path for safe regex matching
  - Pattern matches `<!-- ai-prompt: {prompt} -->\n[ \t]*![]({path})` to handle optional leading whitespace
  - When SelectedImage is nil (adding new image), DeleteOldImage() returns nil silently
  - When SelectedImage is nil, ReplaceImageInMarkdown() returns error (use InsertImageIntoMarkdown() instead)
  - Full regeneration workflow: SaveGeneratedImage() -> ReplaceImageInMarkdown() -> DeleteOldImage()
---

## 2026-01-25 - US-019
- What was implemented: Return to main dev view after successful image generation
- Files changed:
  - `internal/tui/imagegen.go` - Added viewDone() method, handleDoneKey() method, SavedImagePath field
  - `internal/tui/dev.go` - Integrated Done step handling: save image, insert/replace in markdown, delete old image, send reload event
  - `internal/tui/imagegen_test.go` - Added 9 unit tests for Done step behavior
- **Learnings for future iterations:**
  - Done step returns nil from Update() to signal completion to parent (same pattern as cancel)
  - Parent checks wasInDoneStep and savedPath before clearing imageGenModel to determine if it was completion vs cancellation
  - Image saving and markdown insertion happen in dev.go's Update() when Step becomes Done (not in handleDoneKey)
  - Reload event is sent with the saved filename for activity log visibility
  - Accept enter, esc, or space to dismiss the Done view (user-friendly)
  - The full completion workflow: Generate -> Save to disk -> Insert/Replace markdown -> Delete old image (if regenerating) -> Show success -> User dismisses -> Return to main view
---
