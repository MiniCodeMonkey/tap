{
  "project": "Tap",
  "branchName": "ralph/mermaid-ai-images",
  "description": "Mermaid Charts & AI Image Generation - Native mermaid diagram support with theme matching, plus TUI-based AI image generation via Gemini API",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add mermaid.js to frontend bundle",
      "description": "As a developer, I need mermaid.js installed and configured in the frontend build so diagrams can be rendered client-side.",
      "acceptanceCriteria": [
        "Install mermaid package via npm",
        "Import mermaid in frontend entry point",
        "Configure mermaid with startOnLoad: false for manual initialization",
        "Verify mermaid is included in build output",
        "Unit test for mermaid initialization",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Detect and render mermaid code blocks",
      "description": "As a presenter, I want code blocks with language 'mermaid' to render as diagrams instead of code.",
      "acceptanceCriteria": [
        "Detect code blocks with language identifier 'mermaid' in SlideRenderer",
        "Call mermaid.render() for each mermaid block",
        "Replace code block content with rendered SVG",
        "Diagrams render in both dev server and built output",
        "Unit tests for mermaid block detection",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Handle mermaid syntax errors gracefully",
      "description": "As a presenter, I want to see helpful error messages when my mermaid syntax is invalid.",
      "acceptanceCriteria": [
        "Catch mermaid.render() errors",
        "Display user-friendly error message in place of diagram",
        "Show the original mermaid code alongside error",
        "Error styling matches theme (red/warning colors)",
        "Unit tests for error handling",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Auto-scale mermaid diagrams to fit slide bounds",
      "description": "As a presenter, I want large diagrams to automatically scale down to fit within the slide.",
      "acceptanceCriteria": [
        "Wrap mermaid SVG output in a container with max-width/max-height constraints",
        "Use CSS to scale diagram proportionally (object-fit: contain or similar)",
        "Diagram never overflows slide bounds",
        "Small diagrams remain at natural size (no upscaling)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Create mermaid theme mapping for Paper and Noir themes",
      "description": "As a presenter, I want mermaid diagrams to match the Paper and Noir presentation themes.",
      "acceptanceCriteria": [
        "Create getMermaidTheme() function that maps tap theme to mermaid config",
        "Paper theme uses mermaid 'neutral' theme with light colors",
        "Noir theme uses mermaid 'dark' theme with gold accent",
        "Diagrams use theme's font family",
        "Unit tests for theme mapping logic",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Create mermaid theme mapping for Aurora, Phosphor, and Poster themes",
      "description": "As a presenter, I want mermaid diagrams to match the Aurora, Phosphor, and Poster themes.",
      "acceptanceCriteria": [
        "Aurora theme uses mermaid 'forest' theme with teal/purple accents",
        "Phosphor theme uses mermaid 'dark' theme with green (#00ff00) accent",
        "Poster theme uses mermaid 'default' theme with high contrast black/white/red",
        "Unit tests for theme mapping logic",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Re-render mermaid diagrams on theme change",
      "description": "As a presenter, I want diagrams to update when I switch themes via the TUI.",
      "acceptanceCriteria": [
        "Listen for theme changes in presentation store",
        "Re-initialize mermaid with new theme config when theme changes",
        "Re-render all mermaid diagrams on current slide",
        "Theme switch reflects in diagrams within one hot reload cycle",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Create Gemini API client in Go backend",
      "description": "As a developer, I need a Go client for the Gemini API to generate images.",
      "acceptanceCriteria": [
        "Create internal/gemini/client.go with GenerateImage function",
        "Read GEMINI_API_KEY from environment",
        "Use Nano Banana Pro model for image generation",
        "Return image bytes and content type on success",
        "Return structured error on API failure (rate limit, content policy, etc.)",
        "Integration tests with mocked HTTP responses",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Add image generation shortcut to dev TUI",
      "description": "As a presenter, I want to press 'i' during tap dev to start the image generation workflow.",
      "acceptanceCriteria": [
        "Add 'i' key handler in DevModel.handleKeyPress",
        "Check for GEMINI_API_KEY in environment",
        "If key missing, show error message explaining how to configure it in .env",
        "If key present, set showImageGenerator flag to true",
        "Update help text to show 'i' shortcut",
        "Unit tests for key handling and API key validation",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Create slide selector for image generation",
      "description": "As a presenter, I want to select which slide to add an image to.",
      "acceptanceCriteria": [
        "Create ImageGenModel with slide selection step",
        "Show numbered list of all slides with titles/first headings",
        "Navigate with up/down arrows or j/k",
        "Current selection highlighted",
        "Press enter to select slide",
        "Press esc to cancel and return to main dev view",
        "Unit tests for slide list rendering and navigation",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Detect existing AI-generated images on slides",
      "description": "As a presenter, I want to see which slides already have AI-generated images.",
      "acceptanceCriteria": [
        "Parse markdown to find <!-- ai-prompt: ... --> comments",
        "Extract prompt text and associated image path",
        "Show indicator next to slides with AI images in selector (e.g., '[has 1 AI image]')",
        "Unit tests for ai-prompt comment parsing",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Show add/regenerate options for slides with existing images",
      "description": "As a presenter, I want to choose between adding a new image or regenerating an existing one.",
      "acceptanceCriteria": [
        "When slide has existing AI images, show options: 'Add new image' and 'Regenerate: [prompt preview]'",
        "If multiple AI images exist, show each as a separate regenerate option",
        "Navigate options with up/down, select with enter",
        "Selecting 'Add new image' proceeds to prompt input",
        "Selecting regenerate option pre-fills prompt with existing prompt",
        "Unit tests for image selection with multiple images",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Create prompt input for image generation",
      "description": "As a presenter, I want to type a prompt for the AI image generator.",
      "acceptanceCriteria": [
        "Add prompt input step to ImageGenModel using textinput.Model",
        "Support multi-line input",
        "Press enter or ctrl+d to submit prompt",
        "Press esc to go back to slide selector",
        "Pre-fill with existing prompt when regenerating",
        "Unit tests for prompt input handling",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Generate image and show progress",
      "description": "As a presenter, I want to see progress while the image is being generated.",
      "acceptanceCriteria": [
        "Show spinner with 'Generating image...' message while API call is in progress",
        "Disable 'i' shortcut while generation is in progress",
        "Call Gemini API client with prompt",
        "On success, proceed to save step",
        "On error, display user-friendly error message and allow retry or cancel",
        "Unit tests for progress states and error handling",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Create images directory if needed",
      "description": "As a presenter, I want the images directory created automatically.",
      "acceptanceCriteria": [
        "Check if images/ directory exists relative to markdown file",
        "If not, create it with os.MkdirAll",
        "Works with both relative and absolute paths",
        "Unit tests for directory creation logic",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Save generated image to disk",
      "description": "As a presenter, I want generated images saved with content-hashed filenames.",
      "acceptanceCriteria": [
        "Generate filename using first 8 chars of SHA256 hash of image content",
        "Save image to images/ directory (e.g., images/generated-a1b2c3d4.png)",
        "Determine file extension from content type returned by API",
        "Unit tests for filename generation",
        "Integration tests for file writing",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Insert image into markdown file",
      "description": "As a presenter, I want the generated image automatically inserted into my markdown.",
      "acceptanceCriteria": [
        "Insert at end of selected slide's content (before next --- separator)",
        "Use format: <!-- ai-prompt: {prompt} -->\\n![](images/filename.png)",
        "No alt text in image syntax",
        "Preserve existing markdown formatting",
        "Hot reload triggers automatically after file update",
        "Unit tests for markdown insertion logic",
        "Integration tests for file modification",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Handle image regeneration",
      "description": "As a presenter, I want regenerated images to replace the old ones cleanly.",
      "acceptanceCriteria": [
        "Delete old image file after successful replacement",
        "Update markdown with new image path and prompt comment",
        "Preserve image position in markdown (don't move to end of slide)",
        "Integration tests for file replacement",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Return to main dev view after successful generation",
      "description": "As a presenter, I want to return to the main TUI view after generating an image.",
      "acceptanceCriteria": [
        "Show success message with generated filename",
        "After brief delay or keypress, return to main dev view",
        "Reset ImageGenModel state for next use",
        "Send reload event to update TUI activity log",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": true,
      "notes": ""
    }
  ]
}
